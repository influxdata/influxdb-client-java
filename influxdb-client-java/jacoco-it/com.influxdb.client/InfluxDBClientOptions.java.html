<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InfluxDBClientOptions.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">The Java InfluxDB 2.x Client</a> &gt; <a href="index.source.html" class="el_package">com.influxdb.client</a> &gt; <span class="el_source">InfluxDBClientOptions.java</span></div><h1>InfluxDBClientOptions.java</h1><pre class="source lang-java linenums">/*
 * The MIT License
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
package com.influxdb.client;

import java.io.IOException;
import java.io.InputStream;
import java.time.Duration;
import java.time.temporal.ChronoUnit;
import java.util.Collections;
import java.util.Properties;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.annotation.Nonnull;
import javax.annotation.Nullable;
import javax.annotation.concurrent.NotThreadSafe;

import com.influxdb.LogLevel;
import com.influxdb.client.domain.WriteConsistency;
import com.influxdb.client.domain.WritePrecision;
import com.influxdb.client.write.PointSettings;
import com.influxdb.client.write.WriteParameters;
import com.influxdb.exceptions.InfluxException;
import com.influxdb.utils.Arguments;

import okhttp3.HttpUrl;
import okhttp3.OkHttpClient;
import okhttp3.Protocol;

/**
 * InfluxDBClientOptions are used to configure theInfluxDB 2.x connections.
 *
 * @author Jakub Bednar (bednar@github) (05/09/2018 10:22)
 */
public final class InfluxDBClientOptions {

<span class="fc" id="L55">    private static final Pattern TAGS_PROPERTY = Pattern.compile(&quot;(influx2\\.tags\\.)(.+)&quot;);</span>
<span class="fc" id="L56">    private static final Pattern DURATION_PATTERN = Pattern.compile(&quot;^(\\d+)([a-zA-Z]{0,2})$&quot;);</span>

    private final String url;
    private final String clientType;
    private final OkHttpClient.Builder okHttpClient;
    private final LogLevel logLevel;

    private final AuthScheme authScheme;
    private final char[] token;
    private final String username;
    private final char[] password;

    private final String org;
    private final String bucket;
    private final WritePrecision precision;
    private final WriteConsistency consistency;
    private final PointSettings pointSettings;

<span class="fc" id="L74">    private InfluxDBClientOptions(@Nonnull final InfluxDBClientOptions.Builder builder) {</span>

<span class="fc" id="L76">        Arguments.checkNotNull(builder, &quot;InfluxDBClientOptions.Builder&quot;);</span>

<span class="fc" id="L78">        this.url = builder.url;</span>
<span class="fc" id="L79">        this.clientType = builder.clientType;</span>
<span class="fc" id="L80">        this.okHttpClient = builder.okHttpClient;</span>
<span class="fc" id="L81">        this.logLevel = builder.logLevel;</span>
<span class="fc" id="L82">        this.authScheme = builder.authScheme;</span>
<span class="fc" id="L83">        this.token = builder.token;</span>
<span class="fc" id="L84">        this.username = builder.username;</span>
<span class="fc" id="L85">        this.password = builder.password;</span>

<span class="fc" id="L87">        this.org = builder.org;</span>
<span class="fc" id="L88">        this.bucket = builder.bucket;</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        this.precision = builder.precision != null ? builder.precision : WriteParameters.DEFAULT_WRITE_PRECISION;</span>
<span class="fc" id="L90">        this.consistency = builder.consistency;</span>
<span class="fc" id="L91">        this.pointSettings = builder.pointSettings;</span>
<span class="fc" id="L92">    }</span>

    /**
     * The scheme uses to Authentication.
     */
<span class="fc" id="L97">    public enum AuthScheme {</span>

        /**
         * Basic auth.
         */
<span class="fc" id="L102">        SESSION,</span>

        /**
         * Authentication token.
         */
<span class="fc" id="L107">        TOKEN</span>
    }

    /**
     * @return the url to connect to InfluxDB
     * @see InfluxDBClientOptions.Builder#url(String)
     */
    @Nonnull
    public String getUrl() {
<span class="fc" id="L116">        return url;</span>
    }

    /**
     * If the {@code clientType} is not specified the `java`, `kotlin` or `scala` is used depends on the type of client.
     *
     * @return the client type to report as a part of User-Agent to remote server
     * @see InfluxDBClientOptions.Builder#clientType(String)
     */
    @Nullable
    public String getClientType() {
<span class="fc" id="L127">        return clientType;</span>
    }

    /**
     * @return HTTP client to use for communication with InfluxDB
     * @see InfluxDBClientOptions.Builder#okHttpClient(OkHttpClient.Builder)
     */
    @Nonnull
    public OkHttpClient.Builder getOkHttpClient() {
<span class="fc" id="L136">        return okHttpClient;</span>
    }

    /**
     * @return The log level for the request and response information.
     * @see InfluxDBClientOptions.Builder#logLevel(LogLevel)
     */
    @Nonnull
    public LogLevel getLogLevel() {
<span class="fc" id="L145">        return logLevel;</span>
    }

    /**
     * @return the authorization scheme
     * @see InfluxDBClientOptions.Builder#authenticateToken(char[])
     * @see InfluxDBClientOptions.Builder#authenticate(String, char[]) (char[])
     */
    @Nullable
    public AuthScheme getAuthScheme() {
<span class="fc" id="L155">        return authScheme;</span>
    }

    /**
     * @return the token to use for the authorization
     * @see InfluxDBClientOptions.Builder#authenticateToken(char[])
     */
    @Nullable
    public char[] getToken() {
<span class="fc" id="L164">        return token;</span>
    }

    /**
     * @return the username to use in the basic auth
     * @see InfluxDBClientOptions.Builder#authenticate(String, char[])
     */
    @Nullable
    public String getUsername() {
<span class="fc" id="L173">        return username;</span>
    }

    /**
     * @return the password to use in the basic auth
     * @see InfluxDBClientOptions.Builder#authenticate(String, char[])
     */
    @Nullable
    public char[] getPassword() {
<span class="fc" id="L182">        return password;</span>
    }

    /**
     * @return the default destination organization for writes and queries
     * @see InfluxDBClientOptions.Builder#org(String)
     */
    @Nullable
    public String getOrg() {
<span class="fc" id="L191">        return org;</span>
    }

    /**
     * @return default destination bucket for writes
     * @see InfluxDBClientOptions.Builder#bucket(String)
     */
    @Nullable
    public String getBucket() {
<span class="fc" id="L200">        return bucket;</span>
    }

    /**
     * @return default precision for unix timestamps in the line protocol
     * @see InfluxDBClientOptions.Builder#precision(WritePrecision)
     */
    @Nonnull
    public WritePrecision getPrecision() {
<span class="nc" id="L209">        return precision;</span>
    }


    /**
     * The write consistency for the point.
     * &lt;p&gt;
     * InfluxDB assumes that the write consistency is {@link  WriteConsistency#ONE} if you do not specify consistency.
     * See the &lt;a href=&quot;https://bit.ly/enterprise-consistency&quot;&gt;InfluxDB Enterprise documentation&lt;/a&gt; for
     * detailed descriptions of each consistency option.
     *
     * &lt;b&gt;Available with InfluxDB Enterprise clusters only!&lt;/b&gt;
     *
     * @return the write consistency for the point.
     * @see InfluxDBClientOptions.Builder#consistency(WriteConsistency)
     */
    @Nullable
    public WriteConsistency getConsistency() {
<span class="fc" id="L227">        return consistency;</span>
    }

    /**
     * Default tags that will be use for writes by Point and POJO.
     *
     * @return default tags
     * @see InfluxDBClientOptions.Builder#addDefaultTag(String, String)
     */
    @Nonnull
    public PointSettings getPointSettings() {
<span class="fc" id="L238">        return pointSettings;</span>
    }

    /**
     * Creates a builder instance.
     *
     * @return a builder
     */
    @Nonnull
    public static InfluxDBClientOptions.Builder builder() {
<span class="fc" id="L248">        return new InfluxDBClientOptions.Builder();</span>
    }

    /**
     * A builder for {@code InfluxDBClientOptions}.
     */
    @NotThreadSafe
<span class="fc" id="L255">    public static class Builder {</span>

        private String url;
        private String clientType;
        private OkHttpClient.Builder okHttpClient;
        private LogLevel logLevel;

        private AuthScheme authScheme;
        private char[] token;
        private String username;
        private char[] password;

        private String org;
        private String bucket;
        private WritePrecision precision;
        private WriteConsistency consistency;

<span class="fc" id="L272">        private final PointSettings pointSettings = new PointSettings();</span>

        /**
         * Set the url to connect to InfluxDB.
         * &lt;p&gt;
         * The url could be a connection string with various configurations. For more info
         * see: {@link #connectionString(String)}.
         * &lt;/p&gt;
         *
         * @param url the url to connect to InfluxDB (required). Example: http://localhost:8086?readTimeout=5000
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder url(@Nonnull final String url) {
<span class="fc" id="L286">            Arguments.checkNonEmpty(url, &quot;url&quot;);</span>

<span class="fc" id="L288">            connectionString(url);</span>

<span class="fc" id="L290">            return this;</span>
        }

        /**
         * Set the {@code clientType} to customize the User-Agent HTTP header.
         * &lt;p&gt;
         * If the {@code clientType} is set to &quot;awesome-service&quot; the User-Agent header will be:
         * &lt;code&gt;influxdb-client-awesome-service/6.2.0&lt;/code&gt;.
         *
         * @param clientType the client type to report as a part of User-Agent to remote server
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder clientType(@Nonnull final String clientType) {
<span class="fc" id="L304">            Arguments.checkNonEmpty(clientType, &quot;clientType&quot;);</span>

<span class="fc" id="L306">            this.clientType = clientType;</span>

<span class="fc" id="L308">            return this;</span>
        }

        /**
         * Set the HTTP client to use for communication with InfluxDB.
         *
         * @param okHttpClient the HTTP client to use.
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder okHttpClient(@Nonnull final OkHttpClient.Builder okHttpClient) {

<span class="nc" id="L320">            Arguments.checkNotNull(okHttpClient, &quot;OkHttpClient.Builder&quot;);</span>

<span class="nc" id="L322">            this.okHttpClient = okHttpClient;</span>

<span class="nc" id="L324">            return this;</span>
        }

        /**
         * Set the log level for the request and response information.
         *
         * @param logLevel The log level for the request and response information.
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder logLevel(@Nonnull final LogLevel logLevel) {

<span class="fc" id="L336">            Arguments.checkNotNull(logLevel, &quot;logLevel&quot;);</span>

<span class="fc" id="L338">            this.logLevel = logLevel;</span>

<span class="fc" id="L340">            return this;</span>
        }

        /**
         * Setup authorization by {@link AuthScheme#SESSION}.
         *
         * &lt;p&gt;
         * The &lt;i&gt;username/password&lt;/i&gt; auth is based on
         * &lt;a href=&quot;http://bit.ly/http-basic-auth&quot;&gt;HTTP &quot;Basic&quot; authentication&lt;/a&gt;. The authorization expires when the
         * &lt;a href=&quot;http://bit.ly/session-length&quot;&gt;time-to-live (TTL)&lt;/a&gt; (default 60 minutes) is reached
         * and client produces {@link com.influxdb.exceptions.UnauthorizedException}.
         * &lt;/p&gt;
         *
         * @param username the username to use in the basic auth
         * @param password the password to use in the basic auth
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder authenticate(@Nonnull final String username,
                                                          @Nonnull final char[] password) {

<span class="fc" id="L361">            Arguments.checkNonEmpty(username, &quot;username&quot;);</span>
<span class="fc" id="L362">            Arguments.checkNotNull(password, &quot;password&quot;);</span>

<span class="fc" id="L364">            this.authScheme = AuthScheme.SESSION;</span>
<span class="fc" id="L365">            this.username = username;</span>
<span class="fc" id="L366">            this.password = password;</span>

<span class="fc" id="L368">            return this;</span>
        }

        /**
         * Setup authorization by {@link AuthScheme#TOKEN}.
         *
         * @param token the token to use for the authorization
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder authenticateToken(final char[] token) {

<span class="fc" id="L380">            Arguments.checkNotNull(token, &quot;token&quot;);</span>

<span class="fc" id="L382">            this.authScheme = AuthScheme.TOKEN;</span>
<span class="fc" id="L383">            this.token = token;</span>

<span class="fc" id="L385">            return this;</span>
        }

        /**
         * Specify the default destination organization for writes and queries.
         *
         * @param org the default destination organization for writes and queries
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder org(@Nullable final String org) {

<span class="fc" id="L397">            this.org = org;</span>

<span class="fc" id="L399">            return this;</span>
        }

        /**
         * Specify the default destination bucket for writes.
         *
         * @param bucket default destination bucket for writes
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder bucket(@Nullable final String bucket) {

<span class="fc" id="L411">            this.bucket = bucket;</span>

<span class="fc" id="L413">            return this;</span>
        }

        /**
         * Specify the default precision for unix timestamps in the line protocol.
         *
         * @param precision default precision for unix timestamps in the line protocol
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder precision(@Nullable final WritePrecision precision) {

<span class="fc" id="L425">            this.precision = precision;</span>

<span class="fc" id="L427">            return this;</span>
        }

        /**
         * Specify the write consistency for the point.
         * &lt;p&gt;
         * InfluxDB assumes that the write consistency is {@link  WriteConsistency#ONE}
         * if you do not specify consistency.
         * See the &lt;a href=&quot;https://bit.ly/enterprise-consistency&quot;&gt;InfluxDB Enterprise documentation&lt;/a&gt; for
         * detailed descriptions of each consistency option.
         *
         * &lt;b&gt;Available with InfluxDB Enterprise clusters only!&lt;/b&gt;
         *
         * @param consistency The write consistency for the point.
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder consistency(@Nullable final WriteConsistency consistency) {

<span class="fc" id="L446">            this.consistency = consistency;</span>

<span class="fc" id="L448">            return this;</span>
        }

        /**
         * Add default tag that will be use for writes by Point and POJO.
         * &lt;p&gt;
         * The expressions can be:
         * &lt;ul&gt;
         * &lt;li&gt;&quot;California Miner&quot; - static value&lt;/li&gt;
         * &lt;li&gt;&quot;${version}&quot; - system property&lt;/li&gt;
         * &lt;li&gt;&quot;${env.hostname}&quot; - environment property&lt;/li&gt;
         * &lt;/ul&gt;
         *
         * @param key        the tag name
         * @param expression the tag value expression
         * @return this
         */
        @Nonnull
        public InfluxDBClientOptions.Builder addDefaultTag(@Nonnull final String key,
                                                           @Nullable final String expression) {

<span class="fc" id="L469">            Arguments.checkNotNull(key, &quot;tagName&quot;);</span>

<span class="fc" id="L471">            pointSettings.addDefaultTag(key, expression);</span>

<span class="fc" id="L473">            return this;</span>
        }

        /**
         * Configure Builder via connection string. The allowed configuration:
         *
         * &lt;ul&gt;
         *     &lt;li&gt;&lt;code&gt;org&lt;/code&gt; - default destination organization for writes and queries&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;bucket&lt;/code&gt; - default destination bucket for writes&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;token&lt;/code&gt; - the token to use for the authorization&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;logLevel&lt;/code&gt; - rest client verbosity level&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;readTimeout&lt;/code&gt; - read timeout&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;writeTimeout&lt;/code&gt; - write timeout&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;connectTimeout&lt;/code&gt; - socket timeout&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;precision&lt;/code&gt; - default precision for unix timestamps in the line protocol&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;consistency&lt;/code&gt; - specify the write consistency for the point&lt;/li&gt;
         *     &lt;li&gt;&lt;code&gt;clientType&lt;/code&gt; - to customize the User-Agent HTTP header&lt;/li&gt;
         * &lt;/ul&gt;
         * &lt;p&gt;
         * Connection string example:
         * &lt;pre&gt;
         * http://localhost:8086?readTimeout=30000&amp;amp;token=my-token&amp;amp;bucket=my-bucket&amp;amp;org=my-org
         * &lt;/pre&gt;
         *
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder connectionString(@Nonnull final String connectionString) {

<span class="fc" id="L502">            Arguments.checkNonEmpty(connectionString, &quot;url&quot;);</span>

<span class="fc" id="L504">            ParsedUrl parsedUrl = new ParsedUrl(connectionString);</span>
<span class="fc" id="L505">            HttpUrl parse = parsedUrl.httpUrl;</span>

<span class="fc" id="L507">            String org = parse.queryParameter(&quot;org&quot;);</span>
<span class="fc" id="L508">            String bucket = parse.queryParameter(&quot;bucket&quot;);</span>
<span class="fc" id="L509">            String token = parse.queryParameter(&quot;token&quot;);</span>
<span class="fc" id="L510">            String logLevel = parse.queryParameter(&quot;logLevel&quot;);</span>
<span class="fc" id="L511">            String readTimeout = parse.queryParameter(&quot;readTimeout&quot;);</span>
<span class="fc" id="L512">            String writeTimeout = parse.queryParameter(&quot;writeTimeout&quot;);</span>
<span class="fc" id="L513">            String connectTimeout = parse.queryParameter(&quot;connectTimeout&quot;);</span>
<span class="fc" id="L514">            String precision = parse.queryParameter(&quot;precision&quot;);</span>
<span class="fc" id="L515">            String consistency = parse.queryParameter(&quot;consistency&quot;);</span>
<span class="fc" id="L516">            String clientType = parse.queryParameter(&quot;clientType&quot;);</span>

<span class="fc" id="L518">            String url = parsedUrl.urlWithoutParams;</span>
<span class="fc" id="L519">            return configure(url, org, bucket, token, logLevel, readTimeout, writeTimeout, connectTimeout,</span>
                    precision, consistency, clientType);
        }

        /**
         * Configure Builder via {@code influx2.properties}.
         *
         * @return {@code this}
         */
        @Nonnull
        public InfluxDBClientOptions.Builder loadProperties() {

<span class="fc" id="L531">            try (InputStream inputStream = this.getClass().getResourceAsStream(&quot;/influx2.properties&quot;)) {</span>

<span class="fc" id="L533">                Properties properties = new Properties();</span>
<span class="fc" id="L534">                properties.load(inputStream);</span>

<span class="fc" id="L536">                String url = properties.getProperty(&quot;influx2.url&quot;);</span>
<span class="fc" id="L537">                String org = properties.getProperty(&quot;influx2.org&quot;);</span>
<span class="fc" id="L538">                String bucket = properties.getProperty(&quot;influx2.bucket&quot;);</span>
<span class="fc" id="L539">                String token = properties.getProperty(&quot;influx2.token&quot;);</span>
<span class="fc" id="L540">                String logLevel = properties.getProperty(&quot;influx2.logLevel&quot;);</span>
<span class="fc" id="L541">                String readTimeout = properties.getProperty(&quot;influx2.readTimeout&quot;);</span>
<span class="fc" id="L542">                String writeTimeout = properties.getProperty(&quot;influx2.writeTimeout&quot;);</span>
<span class="fc" id="L543">                String connectTimeout = properties.getProperty(&quot;influx2.connectTimeout&quot;);</span>
<span class="fc" id="L544">                String precision = properties.getProperty(&quot;influx2.precision&quot;);</span>
<span class="fc" id="L545">                String consistency = properties.getProperty(&quot;influx2.consistency&quot;);</span>
<span class="fc" id="L546">                String clientType = properties.getProperty(&quot;influx2.clientType&quot;);</span>

                //
                // Default tags
                //
<span class="fc" id="L551">                properties.stringPropertyNames().forEach(key -&gt; {</span>

<span class="fc" id="L553">                    Matcher matcher = TAGS_PROPERTY.matcher(key);</span>

<span class="fc bfc" id="L555" title="All 2 branches covered.">                    if (matcher.matches()) {</span>
<span class="fc" id="L556">                        String tagKey = matcher.group(2);</span>
<span class="fc" id="L557">                        addDefaultTag(tagKey, properties.getProperty(key).trim());</span>

                    }
<span class="fc" id="L560">                });</span>

<span class="fc" id="L562">                return configure(url, org, bucket, token, logLevel, readTimeout, writeTimeout, connectTimeout,</span>
                        precision, consistency, clientType);

<span class="nc" id="L565">            } catch (IOException e) {</span>
<span class="nc" id="L566">                throw new IllegalStateException(e);</span>
            }
        }

        /**
         * Build an instance of InfluxDBClientOptions.
         *
         * @return {@link InfluxDBClientOptions}
         */
        @Nonnull
        public InfluxDBClientOptions build() {

<span class="pc bpc" id="L578" title="1 of 2 branches missed.">            if (url == null) {</span>
<span class="nc" id="L579">                throw new IllegalStateException(&quot;The url to connect to InfluxDB has to be defined.&quot;);</span>
            }

<span class="pc bpc" id="L582" title="1 of 2 branches missed.">            if (okHttpClient == null) {</span>
<span class="nc" id="L583">                okHttpClient = new OkHttpClient.Builder()</span>
<span class="nc" id="L584">                        .protocols(Collections.singletonList(Protocol.HTTP_1_1));</span>
            }

<span class="fc bfc" id="L587" title="All 2 branches covered.">            if (logLevel == null) {</span>
<span class="fc" id="L588">                logLevel = LogLevel.NONE;</span>
            }

<span class="fc" id="L591">            return new InfluxDBClientOptions(this);</span>
        }

        @Nonnull
        private InfluxDBClientOptions.Builder configure(@Nonnull final String url,
                                                        @Nullable final String org,
                                                        @Nullable final String bucket,
                                                        @Nullable final String token,
                                                        @Nullable final String logLevel,
                                                        @Nullable final String readTimeout,
                                                        @Nullable final String writeTimeout,
                                                        @Nullable final String connectTimeout,
                                                        @Nullable final String precision,
                                                        @Nullable final String consistency,
                                                        @Nullable final String clientType) {

<span class="fc" id="L607">            this.url = new ParsedUrl(url).urlWithoutParams;</span>
<span class="fc bfc" id="L608" title="All 2 branches covered.">            if (org != null) {</span>
<span class="fc" id="L609">                org(org);</span>
            }
<span class="fc bfc" id="L611" title="All 2 branches covered.">            if (bucket != null) {</span>
<span class="fc" id="L612">                bucket(bucket);</span>
            }

<span class="fc bfc" id="L615" title="All 2 branches covered.">            if (token != null) {</span>
<span class="fc" id="L616">                authenticateToken(token.toCharArray());</span>
            }

<span class="fc bfc" id="L619" title="All 2 branches covered.">            if (logLevel != null) {</span>
<span class="fc" id="L620">                logLevel(Enum.valueOf(LogLevel.class, logLevel));</span>
            }

<span class="fc bfc" id="L623" title="All 2 branches covered.">            if (precision != null) {</span>
<span class="fc" id="L624">                precision(Enum.valueOf(WritePrecision.class, precision));</span>
            }

<span class="fc bfc" id="L627" title="All 2 branches covered.">            if (consistency != null) {</span>
<span class="fc" id="L628">                consistency(Enum.valueOf(WriteConsistency.class, consistency));</span>
            }

<span class="fc bfc" id="L631" title="All 2 branches covered.">            if (okHttpClient == null) {</span>
<span class="fc" id="L632">                okHttpClient = new OkHttpClient.Builder()</span>
<span class="fc" id="L633">                        .protocols(Collections.singletonList(Protocol.HTTP_1_1));</span>
            }
<span class="fc bfc" id="L635" title="All 2 branches covered.">            if (readTimeout != null) {</span>
<span class="fc" id="L636">                okHttpClient.readTimeout(toDuration(readTimeout));</span>
            }

<span class="fc bfc" id="L639" title="All 2 branches covered.">            if (writeTimeout != null) {</span>
<span class="fc" id="L640">                okHttpClient.writeTimeout(toDuration(writeTimeout));</span>
            }
<span class="fc bfc" id="L642" title="All 2 branches covered.">            if (connectTimeout != null) {</span>
<span class="fc" id="L643">                okHttpClient.connectTimeout(toDuration(connectTimeout));</span>
            }
<span class="fc bfc" id="L645" title="All 2 branches covered.">            if (clientType != null) {</span>
<span class="fc" id="L646">                clientType(clientType);</span>
            }

<span class="fc" id="L649">            return this;</span>
        }

        @Nonnull
        private Duration toDuration(@Nonnull final String value) {

<span class="fc" id="L655">            Matcher matcher = DURATION_PATTERN.matcher(value);</span>
<span class="pc bpc" id="L656" title="1 of 2 branches missed.">            if (!matcher.matches()) {</span>
<span class="nc" id="L657">                throw new InfluxException(&quot;'&quot; + value + &quot;' is not a valid duration&quot;);</span>
            }

<span class="fc" id="L660">            String amount = matcher.group(1);</span>
<span class="fc" id="L661">            String unit = matcher.group(2);</span>

            ChronoUnit chronoUnit;
<span class="pc bpc" id="L664" title="5 of 8 branches missed.">            switch (unit != null &amp;&amp; !unit.isEmpty() ? unit.toLowerCase() : &quot;ms&quot;) {</span>
                case &quot;ms&quot;:
<span class="nc" id="L666">                    chronoUnit = ChronoUnit.MILLIS;</span>
<span class="nc" id="L667">                    break;</span>
                case &quot;s&quot;:
<span class="fc" id="L669">                    chronoUnit = ChronoUnit.SECONDS;</span>
<span class="fc" id="L670">                    break;</span>
                case &quot;m&quot;:
<span class="nc" id="L672">                    chronoUnit = ChronoUnit.MINUTES;</span>
<span class="nc" id="L673">                    break;</span>
                default:
<span class="nc" id="L675">                    throw new InfluxException(&quot;unknown unit for '&quot; + value + &quot;'&quot;);</span>
            }

<span class="fc" id="L678">            return Duration.of(Long.parseLong(amount), chronoUnit);</span>
        }

        private static final class ParsedUrl {
            @Nonnull
            private final String urlWithoutParams;
            @Nonnull
            private final HttpUrl httpUrl;

<span class="fc" id="L687">            private ParsedUrl(@Nonnull final String connectionString) {</span>

<span class="fc" id="L689">                HttpUrl parse = HttpUrl.parse(connectionString);</span>
<span class="pc bpc" id="L690" title="1 of 2 branches missed.">                if (parse == null) {</span>
<span class="nc" id="L691">                    throw new InfluxException(&quot;Unable to parse connection string &quot; + connectionString);</span>
                }
<span class="fc" id="L693">                this.httpUrl = parse;</span>

<span class="fc" id="L695">                HttpUrl url = this.httpUrl.newBuilder().build();</span>

<span class="fc" id="L697">                String urlWithoutParams = url.scheme() + &quot;://&quot; + url.host() + &quot;:&quot; + url.port() + url.encodedPath();</span>
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">                if (!urlWithoutParams.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L699">                    urlWithoutParams += &quot;/&quot;;</span>
                }

<span class="fc" id="L702">                this.urlWithoutParams = urlWithoutParams;</span>
<span class="fc" id="L703">            }</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>